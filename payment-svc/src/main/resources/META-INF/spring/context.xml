<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"

               xmlns:camel="http://camel.apache.org/schema/spring" xmlns:cxf="http://camel.apache.org/schema/cxf"

               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"

               xmlns:util="http://www.springframework.org/schema/util"

               xmlns:http-conf="http://cxf.apache.org/transports/http/configuration"

               xsi:schemaLocation="

                                             http://www.springframework.org/schema/beans

                                             http://www.springframework.org/schema/beans/spring-beans.xsd

                                             http://camel.apache.org/schema/cxf

                                             http://camel.apache.org/schema/cxf/camel-cxf.xsd

                                             http://camel.apache.org/schema/spring

                                             http://camel.apache.org/schema/spring/camel-spring.xsd

                                             http://www.springframework.org/schema/context

                                             http://www.springframework.org/schema/context/spring-context.xsd

                                             http://www.springframework.org/schema/util

                                             http://www.springframework.org/schema/util/spring-util.xsd

                                             http://cxf.apache.org/transports/http/configuration

                                             http://cxf.apache.org/schemas/configuration/http-conf.xsd">

 

               <import resource="classpath:META-INF/cxf/cxf.xml" />

               <import resource="classpath:META-INF/cxf/cxf-servlet.xml" />

               <import resource="classpath:customers-enrollment-beans.xml" />             

 

               <!-- This configuration is for timeout -->

               <http-conf:conduit name="*.http-conduit">

                              <http-conf:client ReceiveTimeout="${CORE_SERVICES_TIMEOUT}"

                                             ConnectionTimeout="${CORE_SERVICES_TIMEOUT}" />

               </http-conf:conduit>

 

               <!-- Customer Service EndPoint - STARTS here -->

               <cxf:rsServer id="customerService" address="/"

                              loggingFeatureEnabled="true">

                              <cxf:serviceBeans>

                                             <ref bean="customerEnrollmentRS" />

                              </cxf:serviceBeans>

                              <cxf:providers>

                                             <bean class="com.fasterxml.jackson.jaxrs.json.JacksonJaxbJsonProvider" />

                              </cxf:providers>

               </cxf:rsServer>

               <!-- Customer Service EndPoint - ENDs here -->

 

               <!-- Camel Routes - STARTs here -->

               <camelContext id="context" xmlns="http://camel.apache.org/schema/spring">

                             

                              <camel:dataFormats>

                          <camel:json id="clpJsonErrResponse" library="Jackson" unmarshalTypeName="com.aexp.lending.cfe.enrollment.beans.ErrorResponse" />

                          <camel:json id="cfeCustServiceJsonReq" library="Jackson" unmarshalTypeName="com.aexp.lending.cfe.enrollment.beans.CFECustomerServiceJsonReq" />

                          <camel:json id="cfeCustServiceJsonRes" library="Jackson" unmarshalTypeName="com.aexp.lending.cfe.enrollment.beans.CFECustomerServiceJsonRes" />

                              </camel:dataFormats>

                             

 

                              <onException useOriginalMessage="true"

                                             inheritErrorHandler="false">

                                             <!-- <exception>java.lang.Throwable</exception> -->

                                             <exception>java.lang.Exception</exception>

                                             <handled>

                                                            <constant>true</constant>

                                             </handled>

                                             <log message="Exception occurred in Service ${exception.message}"

                                                            loggingLevel="ERROR" />

                                             <process ref="exceptionProcessor" />

                                             <rollback markRollbackOnly="true" />

                              </onException>

 

                              <!-- Customer Service Route starts here -->

                              <route id="invokeCustomerREST">

                                             <from uri="cxfrs:bean:customerService" />

                                             <choice>

                                                            <when>

                                                                           <simple>${header.operationName} == 'createCustomer'</simple>

                                                                           <to uri="direct:invokeCustomerEnrollment" />

                                                            </when>                                                          

                                             </choice>

                              </route>

 

                              <!-- Customer Enrollment Main Route starts here - invoked by Datapower -->

                              <route id="invokeCustomerEnrollment">

                                             <from uri="direct:invokeCustomerEnrollment" />

                                             <!-- Rolling back the transaction on any exception -->

                                             <camel:onException inheritErrorHandler="false">

                                                            <camel:exception>java.lang.Exception</camel:exception>

                                                            <camel:handled>

                                                                           <camel:constant>true</camel:constant>

                                                            </camel:handled>

                                                            <camel:process ref="exceptionProcessor" />

                                                            <camel:rollback markRollbackOnly="true" />

                                             </camel:onException>

                                            

                                             <bean ref="customerEnrollmentProcessor" method="enrollCustomer" />

                                             <transacted ref="PROPAGATION_REQUIRED" />

                                            

                                             <!-- CUSTOMER SETUP Start -->

                                             <process ref="customerEnrollmentPreProcessor" />

                                            

                                             <!-- Duplicate customer check call -->

                                            

                                             <to uri="mybatis:getCustDupCheck?statementType=SelectOne" />

                                             <process ref="checkDuplicateCustomerFlag" />

                                             <when>

                                                            <simple>${header.duplicateCustomerFlag} == 'Y'</simple>                                            

                                                            <process ref="customerEnrollmentProcessorMybatis" />

                                                            <bean ref="sProcMapBuilder" method="getCustomerDataMap" />

                                                            <to uri="mybatis:insertCustomerSP?statementType=Insert" />

                                                            <process ref="customerInsertPostProcessor" />

                                            

                                                            <when>

                                                                           <simple>${body.addressList} != null</simple>

                                                                           <split>

                                                                                          <simple>${body.addressList}</simple>

                                                                                          <bean ref="sProcMapBuilder" method="getAddressDataMap" />

                                                                                          <to uri="mybatis:insertCustomerAddressSP?statementType=Insert" />

                                                                                          <to uri="bean:SPResponseProcessor?method=getAddressResponse" />

                                                                                          <process ref="customerInsertPostProcessor" />

                                                                           </split>

                                                            </when>

                                                            <when>

                                                                           <simple>${body.phoneList} != null</simple>

                                                                           <split>

                                                                                          <simple>${body.phoneList}</simple>

                                                                                          <bean ref="sProcMapBuilder" method="getPhoneDataMap" />

                                                                                          <to uri="mybatis:insertPhoneSP?statementType=Insert" />

                                                                                          <to uri="bean:SPResponseProcessor?method=getPhoneResponse" />

                                                                                          <process ref="customerInsertPostProcessor" />

                                                                           </split>

                                                            </when>

                                                            <when>

                                                                           <simple>${body.emailList} != null</simple>

                                                                           <split>

                                                                                          <simple>${body.emailList}</simple>

                                                                                          <bean ref="sProcMapBuilder" method="getEmailDataMap" />

                                                                                          <to uri="mybatis:insertEmailSP?statementType=Insert" />

                                                                                          <to uri="bean:SPResponseProcessor?method=getEmailResponse" />

                                                                           </split>

                                                            </when>

                                             </when>

                                             <process ref="checkCustomerStatusProcessor" />

                                             <process ref="customerEnrollmentSPResponse" />

                                            

                                             <!-- CUSTOMER SETUP End -->

 

                                             <!-- PROGRAM SETUP Start -->

                                             <process ref="programEnrollmentPreProcessor" />

                                             <when>

                                                            <simple>${header.isError} == 'No'</simple>

                                                            <to uri="mybatis:callGetEnrollmentDetails?statementType=SelectOne" />

                                                            <process ref="checkDuplicateProgramFlagv2" />

                                                            <when>

                                                                           <simple>${header.enrollment_duplicate_status} == 'N'</simple>                                                                  

                                                                           <process ref="programEnrollmentProcessorMybatis" />

                                                                           <bean ref="sProcMapBuilder" method="getProgramDataMap" />

                                                                           <to uri="mybatis:callInsertProductSP?statementType=update" />

                                                                           <process ref="checkDuplicateProgramFlag" />

                                                                           <when>

                                                                                          <simple>${body.loanTermsList} != null</simple>

                                                                                          <split>

                                                                                                         <simple>${body.loanTermsList}</simple>

                                                                                                         <bean ref="sProcMapBuilder" method="getProgramLoanDataMap" />

                                                                                                         <to

                                                                                                                        uri="mybatis:callInsertProductLoanRepayRateSP?statementType=update" />

                                                                                          </split>

                                                                           </when>

                                                            </when>

                                             </when>

                                             <process ref="checkProgramStatusProcessor" />

                                             <bean ref="programEnrollmentSPResponse"></bean>

                                             <!-- PROGRAM SETUP End -->                                   

                                             <when>

                                                            <simple>${header.enrollment_duplicate_status} == 'N' or

                                                                                                                        ${header.enrollment_duplicate_status} == null or

                                                                                                                        ${header.enrollment_duplicate_status} == ''

                                                            </simple>

                                                           

                                                            <!-- CFE SETUP Start -->

                                                            <process ref="processCFECustomerServiceRequest" />

                                                            <marshal ref="cfeCustServiceJsonReq" />

                                                            <setHeader headerName="Content-Type">

                                                                           <simple>application/json</simple>

                                                            </setHeader>

                                                            <setHeader headerName="Accept">

                                                                           <simple>application/json</simple>

                                                            </setHeader>

                                                            <setHeader headerName="CamelHttpMethod">

                                                                           <simple>POST</simple>

                                                            </setHeader>

                                                            <camel:removeHeader headerName="CamelHttpPath" />

                                                            <setExchangePattern pattern="InOut" />

                                                            <convertBodyTo type="java.lang.String" />

                                                            <log message="invoking the rest service with json data...${body}">

                                                                           <description>****Invoking the RESTFUL CFE Service with JSON request</description>

                                                            </log>

                                                            <to         uri="cxfrs:bean:cfeServiceEndpointRestClient?throwExceptionOnFailure=false" />

                                                            <convertBodyTo type="java.lang.String" />

                                                            <log message="CFE http response code...${header.CamelHttpResponseCode} ">

                                                                           <description>****CFE http response code  </description>

                                                            </log>

                                                            <choice>

                                                                           <when>

                                                                                          <simple>${header.CamelHttpResponseCode} == '200'</simple>

                                                                                          <unmarshal ref="cfeCustServiceJsonRes" />

                                                                           </when>

                                                                           <otherwise>

                                                                                          <unmarshal ref="clpJsonErrResponse" />

                                                                           </otherwise>

                                                            </choice>

                                                            <process ref="processCFECustomerServiceResponse" />

                                                            <!-- CFE SETUP end -->

                                                           

                                                            <process ref="customerEnrollmentResponseProcessor" />

                                             </when>

                              </route>

                              <!-- Customer Enrollment Main Route ends here -->                         

 

               </camelContext>

</beans>

 